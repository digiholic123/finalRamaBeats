<% layout('../layout') %>
<div class="container-fluid">
    <div class="row ">
        <div class="col-xl-12 col-md-12">
            <div class="card-box pt-0 pb-0">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item" aria-current="page"><a href="/"> Home </a></li>
                        <li class="breadcrumb-item active" aria-current="page">Cutting Group</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row ">
        <div class="col-xl-12 col-md-12">
            <div class="card-box ">
                <h4 class="mt-0 mb-0 header-title text-center">Cutting Group</h4>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row ">
        <div class="col-xl-8 col-md-12">
            <div class="card-box">
                <p>Search Panel</p>
                    <div class="form-row">
                        <div class="form-group col-xl-4">
                            <label for="gamename">Start Date</label>
                            <input type="text" class="datepicker form-control" placeholder="Select A Date" id="gameDate" autocomplete="off">
                        </div>
                        <div class="form-group col-xl-4">
                            <label for="gamename">Provider Name</label>
                            <select class="form-control" id="providerId">
                                <% for(index in data){  %>
                                    <option value="<%= data[index]._id %>"><%= data[index].providerName%></option>
                                <%} %>
                            </select>
                        </div>
                        <div class="form-group col-xl-4">
                            <label for="gamename">Game Session</label>
                            <select name="session" class="form-control" id="gameSession">
                                <option value="Open">Open</option>
                                <option value="Close">Close</option>
                                <option value="Jodi Digit">Jodi</option>
                                <option value="Half Sangam Digits">Half Sangam</option>
                                <option value="Full Sangam Digits">Full Sangam</option>
                                <!-- <option value="Red Brackets">Red Brackets</option>
                                <option value="Single Pana">Single Pana</option>
                                <option value="Double Pana">Double Pana</option>
                                <option value="Triple Pana">Triple Pana</option>
                                <option value="Single Digit">Single Digit</option> -->
                        
                            </select>
                        </div>
                        <div class="col-xl-12">
                            <button type="submit" class="btn btn-primary btn-sm"  style="float:right;" id="submitInfo">Submit</button>
                        </div>
                    </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-12">
            <div class="card-box">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Type</th>
                                <th>Bids</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="groupData">
                            
                        </tbody>
                        <tfoot id="tfootBids">
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" id="tabDiv" style="display: none;">
    <div class="row ">
        <div class="col-xl-12 col-md-12">
            <div class="card-box">
                <div class="table-responsive" data-pattern="priority-columns">
                    <table id="datatable4" class="table table-bordered dt-responsive nowrap text-center text-dark">
                        <thead>
                            <tr>
                                <th>Digits</th>
                                <th>Bid Count</th>
                                <th>Total Bid Amount </th>
                                <th>Amount To Pay</th>
                                <th>Profit</th>
                                <th>Loss</th>
                            </tr>
                        </thead>
                        <tbody id="singleTable">
                        </tbody>
                        <tfoot id="sumTotal">   
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" id="signleDigitDiv" style="display: none;">
    <div class="row ">
        <div class="col-xl-12 col-md-12">
            <div class="card-box">
                <h3>Single Digits</h3>
                <div class="table-responsive" data-pattern="priority-columns">
                    <table id="datatable5" class="table table-bordered dt-responsive nowrap text-center text-dark">
                        <thead>
                            <tr>
                                <th>Digits</th>
                                <th>Session</th>
                                <th>Bid Count</th>
                                <th>Total Bid Amount</th>
                                <th>Amount To Pay</th>
                                <th>Profit</th>
                                <th>Loss</th>
                            </tr>
                        </thead>
                        <tbody id="singleDigit">
                        </tbody>
                        <tfoot id="sumTotal">   
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" id="panaDiv" style="display: none;">
    <div class="row ">
        <div class="col-xl-12 col-md-12">
            <div class="card-box">
                <h3>Panna Bids</h3>
                <div class="table-responsive" data-pattern="priority-columns">
                    <table id="datatable6" class="table table-bordered dt-responsive nowrap text-center text-dark">
                        <thead>
                            <tr>
                                <th>Digits</th>
                                <th>Session</th>
                                <th>Bid Count</th>
                                <th>Total Bid Amount</th>
                                <th>Amount To Pay</th>
                                <th>Profit</th>
                                <th>Loss</th>
                            </tr>
                        </thead>
                        <tbody id="bodyTab6">
                        </tbody>
                        <tfoot id="sumTotal">   
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade bs-example-modal-xl show" id="exampleModalScrollable" tabindex="-1" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-modal="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myExtraLargeModalLabel">Bid History</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" data-pattern="priority-columns">
                    <table id="datatable2" class="table table-bordered dt-responsive nowrap text-center text-dark">
                        <thead>
                            <tr>	
                                <th>Sno</th>		
                                <th>User Name</th>
                                <th>Bracket</th>
                                <th>Amount </th>
                                <th>Win status</th>
                                <th>Played Time</th>
                            </tr>
                        </thead>
                        <tbody id="modalTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $("#submitInfo").click(function(){

        const gameDate = $("#gameDate").val();
        const gameSession = $("#gameSession").val();
        const providerId = $("#providerId").val();
        $('#datatable4').DataTable().destroy();
        $('#datatable5').DataTable().destroy();
        $('#datatable6').DataTable().destroy();

        if(gameSession !== "Open" && gameSession !== "Close")
        {
            $('#signleDigitDiv').css('display','none');
            $('#panaDiv').css('display','none');
            $.ajax({
            type: "POST",
            url: "/cuttinggroup/getCutting",
            data: {gameDate : gameDate, gameSession : gameSession, providerId : providerId },
            success: function(data){
                $('#tabDiv').css('display','block');
                let html;
                let TotalBid = 0;
                let TotalSum = 0;
                let i = 1;
                if ( data.status === 0){
                    $('#tabDiv').css('display','none');
                    toastr["warning"]("No Data Found","Indo Bets Games");
                    $('#groupData').html(' ');
                    $('#tfootBids').html(' ');
                }
                else{
                        data.data1.forEach(function(e)
                        {
                            html +='<tr><td>'+e.gameTypeName+'</td><td>'+e.countBid+'</td><td>'+e.sumdigit+'</td></tr>';
                            TotalBid = TotalBid + e.countBid;
                            TotalSum = TotalSum + e.sumdigit;
                        });
                        $("#groupData").html(html);
                        $("#tfootBids").html('<tr><th>Grand Total</th><th>'+ TotalBid +'</th><th>'+ TotalSum +'</th></tr>');
                        $("#datatable").DataTable().clear();
                        let singleData = '';
                        let jodiArray = [];
                        console.log(data.data2,"data.data2.data.data2.data.data2.")
                        data.data2.forEach(function(e){
                            let i=1;
                            let total = 0;
                            let loss = 0;
                            let profit = 0;
                            let pl = e.sumdigit * e.gamePrice;
                            if(pl > TotalSum){//loss
                                loss = pl - TotalSum;
                            }
                            else{//profit
                                profit = TotalSum - pl;
                            }

                            if(gameSession != 'Jodi Digit'){
                                     singleData += '<tr><td>'+ e._id +'</td>\
                                <td><a href="#"  data-id="'+ providerId +'" data-date="'+gameDate+'" data-session="Close" data-digit="'+e._id+'"    data-toggle="modal" data-target=".bs-example-modal-xl" onclick="getBidInfo(this)" style="color:#505050;font-weight: 500;">View Bids Info ('+e.countBid+') </a></td>\
                                <td>'+ e.sumdigit +'</td>\
                                <td>'+ e.sumdigit * e.gamePrice +'</td>\
                                <td style="color:#22b922">'+ profit +'</td>\
                                <td style="color:red">'+ loss  +'</td></tr>';
                            }
                            else{
                                if(jodiArray.includes(e._id)){
                                    e.countBid++;
                                    jodiArray[e._id] = { 'Digit' : e._id, 
                                    'bidCount' : e.countBid,
                                    'sumdigit' : e.sumdigit,
                                    'amountToPay' : e.sumdigit*e.gamePrice,
                                    'profit' : profit,
                                    'loss' : loss
                                }
                                }else{
                                    jodiArray[e._id] = { 'Digit' : e._id, 
                                    'bidCount' : e.countBid,
                                    'sumdigit' : e.sumdigit,
                                    'amountToPay' : e.sumdigit*e.gamePrice,
                                    'profit' : profit,
                                    'loss' : loss
                                }
                                }
                            }    
                    });
                    if(gameSession != 'Jodi Digit'){
                        $("#singleTable").html(singleData);
                        $('#datatable4').DataTable({
                             "pageLength": 50
                        });
                    }

                    if(gameSession === 'Jodi Digit'){
                        var panaArray = [
                            "00",'01',"02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37",'38',"39","40","41","42","43","44","45","46","47",'48',"49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99" ]
                        let jodiTable = '';
                        panaArray.forEach(function(e)
                        {   

                            let Digit = e;
                            let bidCount = 0;
                            let amountToPay = 0;
                            let sumdigit = 0;
                            let profit = TotalSum;
                            let loss = 0;
                            if(jodiArray[Digit]){
                               bidCount = jodiArray[Digit].bidCount;
                               amountToPay = jodiArray[Digit].amountToPay; 
                               sumdigit = jodiArray[Digit].sumdigit; 
                               profit = jodiArray[Digit].profit;
                               loss = jodiArray[Digit].loss; 
                            }
                            jodiTable += '<tr><td>'+ Digit +'</td>\
                                <td><a href="#"  data-id="'+ providerId +'" data-date="'+gameDate+'" data-session="Close" data-digit="'+Digit+'" data-toggle="modal" data-target=".bs-example-modal-xl" onclick="getBidInfo(this)" style="color:#505050;font-weight: 500;">View Bids Info ('+bidCount+') </a></td>\
                                <td>'+ sumdigit +'</td>\
                                <td>'+ amountToPay +'</td>\
                                <td style="color:#22b922">'+ profit +'</td>\
                                <td style="color:red">'+ loss  +'</td></tr>';
                        });
                        $('#singleTable').html(jodiTable);
                        $('#datatable4').DataTable({
                             "pageLength": 50
                        });
                    }
                }
            },
            error: function(error){
                alert('Error Occured Please Try Again Later');
            }
        });
        }
        else
        {
            $('#tabDiv').css('display','none'); 
            $.ajax({
                type: "POST",
                url: "/cuttinggroup/getOC",
                data: {gameDate : gameDate, gameSession : gameSession, providerId : providerId },
                success: function(data)
                {
                    if ( data.status === 0){
                        toastr["warning"]("No Data Found","Indo Bets Games");
                        $('#groupData').html(' ');
                        $('#tfootBids').html(' ');
                    }
                    else
                    {   
                        let i = 0;let j=1; let totalPanaSum = 0; let totalBidPanaSum = 0;
                        let totalSum = 0; let totalBidSum = 0;let sumdigit = 0;
                        $('#signleDigitDiv').css('display','block');
                        $('#panaDiv').css('display','block');
                        data.data1.forEach(function(e){
                            let str = e.bidDigit;
                            if(str.length === 3){
                                totalPanaSum = totalPanaSum + e.sumdigit;
                                totalBidPanaSum = totalBidPanaSum + e.countBid;
                            }
                        });
                        const PanaProfit = totalPanaSum
                        let html = '<tr><td>Pana</td><td>'+totalBidPanaSum+'</td><td>'+totalPanaSum+'</td></tr>';
                        data.data1.forEach(function(e){
                            let str = e.bidDigit;
                            if(str.length === 1){
                                html += '<tr><td>'+e.gameTypeName+'</td><td>'+e.countBid+'</td><td>'+e.sumdigit+'</td></tr>';
                                sumdigit = sumdigit + e.sumdigit
                                totalSum = totalPanaSum + e.sumdigit;
                                totalBidSum = totalBidPanaSum + e.countBid;
                            }
                            j++
                        });
                        $("#groupData").html(html);
                        $("#tfootBids").html('<tr><th>Grand Total</th><th>'+ totalBidSum +'</th><th>'+ totalSum +'</th></tr>');
                        let pannaArr = [];
                        let singleArr = [];
                        let allSingle = [{Digit : 0},{Digit : 1},{Digit : 2},{Digit : 3},{Digit : 4},{Digit : 5 },{Digit : 6 },{Digit : 7 },{Digit : 8 },{Digit : 9}]
                        let singleDigit = '';
                        data.data2.forEach(function(e){
                                let str = e._id;
                                if(str.length === 1)
                                { 
                                    let total = 0;
                                    let loss = 0;
                                    let profit = 0;
                                    let pl = e.sumdigit * e.gamePrice;
                                    if(pl > sumdigit){//loss
                                        loss = pl - sumdigit;
                                    }
                                    else{//profit
                                        profit = sumdigit - pl;
                                    }

                                    singleArr[e._id] = { 
                                        'digit' : e._id, 
                                        'bidCount' : e.countBid,
                                        'sumDigit' : e.sumdigit,
                                        'session'  : e.gameSession,
                                        'amountToPay' :pl, 
                                        'profit': profit, 
                                        'Loss' : loss }
                                }
                                else
                                {
                                    let total = 0;
                                    let loss = 0;
                                    let profit = 0;
                                    let pl = e.sumdigit * e.gamePrice;
                                    if(pl > PanaProfit){//loss
                                        loss = pl - PanaProfit;
                                    }
                                    else{//profit
                                        profit = PanaProfit - pl;
                                    }

                                    pannaArr[e._id] = { 
                                        'digit' : e._id, 
                                        'bidCount' : e.countBid,
                                        'sumDigit' : e.sumdigit,
                                        'session'  : e.gameSession,
                                        'amountToPay' :pl, 
                                        'profit': profit, 
                                        'Loss' : loss }
                                }
                        });

                        let  mergeHtml = '';
                        data.pana.forEach(function(e){
                            let tabDigit = e.Digit;
                            let bidCount = 0;
                            let amountToPay = 0;
                            let SumDigit = 0;
                            let profit = PanaProfit;
                            let loss = 0;
                            let session = 'Nil';
                            if(pannaArr[tabDigit]){
                                bidCount = pannaArr[tabDigit].bidCount;
                                amountToPay = pannaArr[tabDigit].amountToPay;
                                SumDigit = pannaArr[tabDigit].sumDigit;
                                profit = pannaArr[tabDigit].profit;
                                loss = pannaArr[tabDigit].Loss;
                                session = pannaArr[tabDigit].session;
                            }

                            mergeHtml += '<tr><td>'+ tabDigit +'-'+ e.DigitFamily +'</td>\
                                <td>'+ session +'</td>\
                                <td><a href="#" data-id="'+providerId+'" data-date="'+gameDate+'" data-session="'+ session +'"  data-digit="'+ tabDigit +'" data-toggle="modal" data-target=".bs-example-modal-xl" onclick="getBidInfo(this)" style="color:#505050;font-weight: 500;">View Bids Info ('+ bidCount +') </a></td>\
                                <td>'+ SumDigit +'</td>\
                                <td>'+ amountToPay +'</td>\
                                <td style="color:#22b922">'+ profit +'</td>\
                                <td style="color:red">'+ loss +'</td></tr>'
                        });
                        $('#bodyTab6').html(mergeHtml);
                        $('#datatable6').dataTable({
                             "pageLength": 50
                        });

                        allSingle.forEach(function (e){
                            let tabDigit = e.Digit;
                            let bidCount = "No Bids";
                            let amountToPay = 0;
                            let SumDigit = 0;
                            let profit = sumdigit;
                            let loss = 0;
                            let session = 'Nil';
                            if(singleArr[tabDigit] ){
                                bidCount = singleArr[tabDigit].bidCount;
                                amountToPay = singleArr[tabDigit].amountToPay;
                                SumDigit = singleArr[tabDigit].sumDigit;
                                profit = singleArr[tabDigit].profit;
                                loss = singleArr[tabDigit].Loss;
                                session = singleArr[tabDigit].session;
                            }
                            singleDigit +=  '<tr><td>'+ tabDigit +'</td>\
                                <td>'+ session +'</td>\
                                <td><a href="#" data-id="'+providerId+'" data-date="'+gameDate+'" data-session="'+ session +'"  data-digit="'+ tabDigit +'" data-toggle="modal" data-target=".bs-example-modal-xl" onclick="getBidInfo(this)" style="color:#505050;font-weight: 500;">View Bids Info ('+ bidCount +') </a></td>\
                                <td>'+ SumDigit +'</td>\
                                <td>'+ amountToPay +'</td>\
                                <td style="color:#22b922" >'+ profit +'</td>\
                                <td style="color: red">'+ loss +'</td></tr>';
                        })
                        $('#singleDigit').html(singleDigit);
                        $('#datatable5').DataTable();
                    }
                },
                error: function(error){
                    alert('Error Occured Please Try Again Later');
                }
            });
        }
    }); 

    function getBidInfo (obj){
        const date = $(obj).attr("data-date");
        const id= $(obj).attr('data-id');
        const digit = $(obj).attr('data-digit');
        const session = $(obj).attr('data-session');
        $('#datatable2').DataTable().destroy();
        $.ajax({
            type : "POST",
            url: '/cuttinggroup/getBidData',
            data: {date: date, id: id, bidDigit: digit, gameSession: session},
            success: function(data)
            {
                console.log(data,"data")
                let i =1;
                let bidData = '';
                $('#datatable5').DataTable().clear();
                data.forEach(function(e) {
                    let status = "Loss"
                    
                    if(e.winStatus === 1){
                        status = "Win"
                    }
                    
                    if(e.winStatus === 0){
                        status = "Pending"
                    }

                    bidData += '<tr><td>'+ i +'</td>\
                        <td>'+ e.userName +'</td>\
                        <td>'+ e.bidDigit +'</td>\
                        <td>'+ e.biddingPoints +'</td>\
                        <td>'+ status +'</td>\
                        <td>'+ e.createdAt +'</td></tr>'
                    i++
                });
                $("#modalTable").html(bidData);
                $("#datatable2").DataTable();
            },
            error: function(error){
                alert('Error Occured Please Try Again Later');
            }
        });
    }
</script>